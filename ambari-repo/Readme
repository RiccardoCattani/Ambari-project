# Work in repository root

# creare cartella conf se non esiste
mkdir -p conf



# Start the Docker containers
docker compose up -d


# creare cartella conf se non esiste
mkdir -p conf

## Creare file hosts per risoluzione hostname container (Accertarsi che gli IP corrispondano a quelli definiti nel docker-compose.yml)
cat > conf/hosts << EOF
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

# Container hostnames
172.19.0.3 bigtop_hostname0
172.19.0.2 bigtop_hostname1
172.19.0.4 bigtop_hostname2
172.19.0.5 bigtop_hostname3
EOF

# Verify connectivity between containers
docker exec -it ambari-repo-bigtop_hostname0-1 ping -c 2 172.19.0.2   # ping bigtop_hostname1
docker exec -it ambari-repo-bigtop_hostname0-1 ping -c 2 172.19.0.4   # ping bigtop_hostname2
docker exec -it ambari-repo-bigtop_hostname0-1 ping -c 2 172.19.0.5   # ping bigtop_hostname3

# Configure SSH Access Between Containers
# Configure SSH on the primary container (bigtop_hostname0)

 # Access the primary container
docker exec -it ambari-repo-bigtop_hostname0-1  bash

# installa openssh-server e client (client e server) se non presenti
yum install -y openssh openssh-server openssh-clients

# Generate SSH key
ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa

# Start SSH service
systemctl enable sshd
systemctl start sshd

# Exit the container
exit

# Configure SSH on the other containers (bigtop_hostname1, bigtop_hostname2, bigtop_hostname3)
# Repeat SSH configuration on all other containers (hostname1, 2, 3)

# For bigtop_hostname1
docker exec -it ambari-repo-bigtop_hostname1-1 bash
yum install -y openssh openssh-server openssh-clients
ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa
systemctl enable sshd
systemctl start sshd
exit


# For bigtop_hostname2
docker exec -it ambari-repo-bigtop_hostname2-1 bash
yum install -y openssh openssh-server openssh-clients
ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa
systemctl enable sshd
systemctl start sshd
exit


# For bigtop_hostname3
docker exec -it ambari-repo-bigtop_hostname3-1 bash
yum install -y openssh openssh-server openssh-clients
ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa
systemctl enable sshd
systemctl start sshd
exit

## Copy SSH key from server to agents
docker cp ambari-repo-bigtop_hostname0-1:/root/.ssh/id_rsa.pub /tmp/id_rsa.pub
cat ~/.ssh/id_rsa.pub | docker exec -i ambari-repo-bigtop_hostname1-1 bash -c 'cat >> ~/.ssh/authorized_keys'
cat ~/.ssh/id_rsa.pub | docker exec -i ambari-repo-bigtop_hostname2-1 bash -c 'cat >> ~/.ssh/authorized_keys'
cat ~/.ssh/id_rsa.pub | docker exec -i ambari-repo-bigtop_hostname3-1 bash -c 'cat >> ~/.ssh/authorized_keys'
rm /tmp/id_rsa.pub

# Entra nel container primario per testare le connessioni SSH
docker exec -it ambari-repo-bigtop_hostname0-1 bash

# Test SSH connections (da dentro ambari-repo-bigtop_hostname0-1)
ssh -o StrictHostKeyChecking=no bigtop_hostname1 echo "Connection successful"
ssh -o StrictHostKeyChecking=no bigtop_hostname2 echo "Connection successful"
ssh -o StrictHostKeyChecking=no bigtop_hostname3 echo "Connection successful"
exit