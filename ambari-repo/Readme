# Work in repository root

# creare cartella conf se non esiste
mkdir -p conf
mkdir -p ssh_keys/server ssh_keys/agent1 ssh_keys/agent2 ssh_keys/agent3


# Start the Docker containers
docker compose -f docker-compose.ambari.yml up -d

# opzionale stop
docker compose -f docker-compose.ambari.yml down

# Per vedere nome e IP dei container (utile per aggiornare il file hosts):
docker ps --format '{{.Names}}' | xargs -n1 -I{} sh -c "echo -n '{}: '; docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' {}"

## Creare file hosts per risoluzione hostname container (Accertarsi che gli IP corrispondano a quelli definiti nel docker-compose.yml)
# Come da docker compose, questi ip sono statici e assegnati ai container
cat > conf/hosts << EOF
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

# Container hostnames (aggiornare con gli IP reali)
172.19.0.4 ambari-server
172.19.0.2 ambari-agent1
172.19.0.3 ambari-agent2
172.19.0.5 ambari-agent3
EOF

# Verify connectivity between containers
docker exec -it ambari-server ping -c 2 172.19.0.2   # ping ambari-agent1
docker exec -it ambari-server ping -c 2 172.19.0.3   # ping ambari-agent2
docker exec -it ambari-server ping -c 2 172.19.0.5   # ping ambari-agent3

# Configure SSH Access Between Containers
# Configure SSH on the primary container (ambari-server)

 # Access the primary container (ambari-server)
docker exec -it ambari-server bash

# installa openssh-server e client (client e server) se non presenti
yum install -y openssh openssh-server openssh-clients

# Generate SSH key
## Genera la chiave SSH in modo persistente (nella cartella montata)
# Generare la chiave SSH per ambari-server in modo persistente (nella cartella montata):
ssh-keygen -t rsa -N "" -f /root/.ssh/id_rsa   # (dentro il container, con volume ./ssh_keys/server)

# Start SSH service
# Se 'service' non è disponibile, avvia direttamente il demone (usa sempre il path assoluto per evitare errori):
/usr/sbin/sshd -D &

# Per ogni container, genera la chiave nella directory dedicata:
## Per ambari-agent1:
# Entra nel container ambari-agent1
docker exec -it ambari-agent1 bash
# installa openssh-server e client (client e server) se non presenti
yum install -y openssh openssh-server openssh-clients
# Genera la chiave SSH in modo persistente (nella cartella montata)
ssh-keygen -t rsa -N "" -f /root/.ssh/id_rsa   # (dentro il container, con volume ./ssh_keys/agent1)
## Per ambari-agent2:
# Entra nel container ambari-agent2
docker exec -it ambari-agent2 bash
# installa openssh-server e client (client e server) se non presenti
yum install -y openssh openssh-server openssh-clients
# Genera la chiave SSH in modo persistente (nella cartella montata)
ssh-keygen -t rsa -N "" -f /root/.ssh/id_rsa   # (dentro il container, con volume ./ssh_keys/agent2)
## Per ambari-agent3:
# Entra nel container ambari-agent3
docker exec -it ambari-agent3 bash
# installa openssh-server e client (client e server) se non presenti
yum install -y openssh openssh-server openssh-clients
# genera chiave SSH in modo persistente (nella cartella montata)
ssh-keygen -t rsa -N "" -f /root/.ssh/id_rsa   # (dentro il container, con volume ./ssh_keys/agent3)

# Ora ogni chiave sarà visibile nella rispettiva cartella ./ssh_keys/<nome> sul tuo host



# Exit the container
exit

# Configure SSH on the other containers (bigtop_hostname1, bigtop_hostname2, bigtop_hostname3)
# Repeat SSH configuration on all other containers (hostname1, 2, 3)

yum install -y openssh openssh-server openssh-clients
ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa
# Avvia il servizio SSH (usa sempre il path assoluto per evitare errori):
/usr/sbin/sshd -D &
exit


yum install -y openssh openssh-server openssh-clients
ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa
# Avvia il servizio SSH (usa sempre il path assoluto per evitare errori):
/usr/sbin/sshd -D &
exit


yum install -y openssh openssh-server openssh-clients
ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa
# Avvia il servizio SSH (usa sempre il path assoluto per evitare errori):
/usr/sbin/sshd -D &
exit


## Copy SSH key from server to agents
docker cp ambari-server:/root/.ssh/id_rsa.pub /tmp/id_rsa.pub
cat ~/.ssh/id_rsa.pub | docker exec -i ambari-agent1 bash -c 'cat >> ~/.ssh/authorized_keys'
cat ~/.ssh/id_rsa.pub | docker exec -i ambari-agent2 bash -c 'cat >> ~/.ssh/authorized_keys'
cat ~/.ssh/id_rsa.pub | docker exec -i ambari-agent3 bash -c 'cat >> ~/.ssh/authorized_keys'
rm /tmp/id_rsa.pub


# Entra nel container primario per testare le connessioni SSH
docker exec -it ambari-server bash

# Test SSH connections (da dentro ambari-server)
ssh -o StrictHostKeyChecking=no ambari-agent1 echo "Connection successful"
ssh -o StrictHostKeyChecking=no ambari-agent2 echo "Connection successful"
ssh -o StrictHostKeyChecking=no ambari-agent3 echo "Connection successful"
exit

# Disable SELinux on all containers
docker exec -it ambari-server bash -c "setenforce 0 && sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config"
docker exec -it ambari-agent1 bash -c "setenforce 0 && sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config"
docker exec -it ambari-agent2 bash -c "setenforce 0 && sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config"
docker exec -it ambari-agent3 bash -c "setenforce 0 && sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config"


## Install necessary packages on all containers
# Per ambari-server
docker exec -it ambari-server bash -c "
dnf install -y sudo openssh-server openssh-clients which iproute net-tools less vim-enhanced &&
dnf install -y initscripts wget curl tar unzip git &&
dnf install -y dnf-plugins-core &&
dnf config-manager --set-enabled powertools &&
dnf update -y
"

# Per ambari-agent1
docker exec -it ambari-agent1 bash -c "
dnf install -y sudo openssh-server openssh-clients which iproute net-tools less vim-enhanced &&
dnf install -y initscripts wget curl tar unzip git &&
dnf install -y dnf-plugins-core &&
dnf config-manager --set-enabled powertools &&
dnf update -y
"

# Per ambari-agent2
docker exec -it ambari-agent2 bash -c "
dnf install -y sudo openssh-server openssh-clients which iproute net-tools less vim-enhanced &&
dnf install -y initscripts wget curl tar unzip git &&
dnf install -y dnf-plugins-core &&
dnf config-manager --set-enabled powertools &&
dnf update -y
"

# Per ambari-agent3
docker exec -it ambari-agent3 bash -c "
dnf install -y sudo openssh-server openssh-clients which iproute net-tools less vim-enhanced &&
dnf install -y initscripts wget curl tar unzip git &&
dnf install -y dnf-plugins-core &&
dnf config-manager --set-enabled powertools &&
dnf update -y
"
## Enable Rocky-Devel repository on all containers
# Per ambari-server
docker exec -it ambari-server bash
# (Modifica manualmente il file con
vi /etc/yum.repos.d/Rocky-Devel.repo
# There are two possible scenarios:
# 1. If all lines are commented (start with #), uncomment all lines
# 2. If you see "enabled=0", change it to "enabled=1"

# Poi esegui:
dnf repolist | grep devel
exit

# Per ambari-agent1
docker exec -it ambari-agent1 bash
# (Modifica manualmente il file con
vi /etc/yum.repos.d/Rocky-Devel.repo
# There are two possible scenarios:
# 1. If all lines are commented (start with #), uncomment all lines
# 2. If you see "enabled=0", change it to "enabled=1"

# Poi esegui:
dnf repolist | grep devel
exit

# Per ambari-agent2
docker exec -it ambari-agent2 bash
# (Modifica manualmente il file con
vi /etc/yum.repos.d/Rocky-Devel.repo
# There are two possible scenarios:
# 1. If all lines are commented (start with #), uncomment all lines
# 2. If you see "enabled=0", change it to "enabled=1"

# Poi esegui:
dnf repolist | grep devel
exit

# Per ambari-agent3
docker exec -it ambari-agent3 bash
# (Modifica manualmente il file con
vi /etc/yum.repos.d/Rocky-Devel.repo
# There are two possible scenarios:
# 1. If all lines are commented (start with #), uncomment all lines
# 2. If you see "enabled=0", change it to "enabled=1"

# Poi esegui:
dnf repolist | grep devel
exit


# =============================
# Install Ambari Server and Agents
# =============================

## Install Ambari Server on bigtop_hostname0
docker exec -it ambari-repo-bigtop_hostname0-1 bash

# Add Ambari repository

# Scarica e installa manualmente Ambari Server (repository non più disponibile)
cd /tmp
curl -O https://archive.apache.org/dist/ambari/ambari-2.7.7.0/redhat8/2.7.7.0-118/ambari-server-2.7.7.0-118.noarch.rpm
curl -O https://archive.apache.org/dist/ambari/ambari-2.7.7.0/redhat8/2.7.7.0-118/ambari-log4j-2.7.7.0-118.noarch.rpm
yum localinstall -y ambari-server-2.7.7.0-118.noarch.rpm ambari-log4j-2.7.7.0-118.noarch.rpm
cd -

# Install Ambari Server
yum install -y ambari-server

# Setup Ambari Server (uses default settings: JDK 8, Postgres embedded, default user)
ambari-server setup -s

# Start Ambari Server
ambari-server start

# Verify Ambari Server is running on port 8080
netstat -tlnp | grep 8080

exit


## Install Ambari Agent on all containers (including bigtop_hostname0)

# For bigtop_hostname0
docker exec -it ambari-repo-bigtop_hostname0-1 bash -c "
yum install -y ambari-agent
sed -i 's/hostname=localhost/hostname=bigtop_hostname0/g' /etc/ambari-agent/conf/ambari-agent.ini
ambari-agent start
"

# For bigtop_hostname1
docker exec -it ambari-repo-bigtop_hostname1-1 bash -c "
wget -O /etc/yum.repos.d/ambari.repo http://public-repo-1.hortonworks.com/ambari/centos8/2.x/updates/2.7.7.0/ambari.repo
yum install -y ambari-agent
sed -i 's/hostname=localhost/hostname=bigtop_hostname0/g' /etc/ambari-agent/conf/ambari-agent.ini
ambari-agent start
"

# For bigtop_hostname2
docker exec -it ambari-repo-bigtop_hostname2-1 bash -c "
wget -O /etc/yum.repos.d/ambari.repo http://public-repo-1.hortonworks.com/ambari/centos8/2.x/updates/2.7.7.0/ambari.repo
yum install -y ambari-agent
sed -i 's/hostname=localhost/hostname=bigtop_hostname0/g' /etc/ambari-agent/conf/ambari-agent.ini
ambari-agent start
"

# For bigtop_hostname3
docker exec -it ambari-repo-bigtop_hostname3-1 bash -c "
wget -O /etc/yum.repos.d/ambari.repo http://public-repo-1.hortonworks.com/ambari/centos8/2.x/updates/2.7.7.0/ambari.repo
yum install -y ambari-agent
sed -i 's/hostname=localhost/hostname=bigtop_hostname0/g' /etc/ambari-agent/conf/ambari-agent.ini
ambari-agent start
"


## Access Ambari Web UI
# Open browser and navigate to:
# http://localhost:8080  (or http://192.168.1.230:8080 from remote)
#
# Default credentials:
# Username: admin
# Password: admin
#
# From Ambari Web UI, you can now:
# 1. Create a cluster
# 2. Install Hadoop services (HDFS, YARN, etc.)
# 3. Manage and monitor your cluster