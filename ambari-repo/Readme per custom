# Work in repository root

# Creare cartelle di configurazione e persistenza chiavi
mkdir -p conf
mkdir -p ssh_keys/server ssh_keys/agent1 ssh_keys/agent2 ssh_keys/agent3
mkdir -p ssh_host_keys/server ssh_host_keys/agent1 ssh_host_keys/agent2 ssh_host_keys/agent3


# Start the Docker containers (Hortonworks images)
docker compose -f docker-compose.ambari.yml up -d

# opzionale stop
docker compose -f docker-compose.ambari.yml down -d

# Per vedere nome e IP dei container (utile per aggiornare il file hosts):
# NB: L'ordine dei container restituito da questo comando può essere diverso da quello nel file hosts.
# Verifica sempre che IP e nome corrispondano!
docker ps --format '{{.Names}}' | xargs -n1 -I{} sh -c "echo -n '{}: '; docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' {}"

## Creare file hosts per risoluzione hostname container (Accertarsi che gli IP corrispondano a quelli definiti nel docker-compose.yml)
# Come da docker compose, questi ip sono statici e assegnati ai container
cat > conf/hosts << EOF
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

# Container hostnames (aggiornare con gli IP reali)
172.19.0.4 ambari-server
172.19.0.2 ambari-agent1
172.19.0.3 ambari-agent2
172.19.0.5 ambari-agent3
EOF

# Verify connectivity between containers
docker exec -it ambari-server ping -c 2 172.19.0.2   # ping ambari-agent1
docker exec -it ambari-server ping -c 2 172.19.0.3   # ping ambari-agent2
docker exec -it ambari-server ping -c 2 172.19.0.5   # ping ambari-agent3

# (Opzionale) Configure SSH Access Between Containers
# Configure SSH on the primary container (ambari-server)

 # Access the primary container (ambari-server)
docker exec -it ambari-server bash

# Generate SSH key
## Genera la chiave SSH in modo persistente (nella cartella montata)
# Generare la chiave SSH per ambari-server in modo persistente (nella cartella montata):

ssh-keygen -t rsa -N "" -f /root/.ssh/id_rsa   # (dentro il container, con volume ./ssh_keys/server)
# Avvia il demone SSH per abilitare l'accesso:
/usr/sbin/sshd -D &


# Le chiavi host SSH ora sono persistenti nella directory montata ./ssh_host_keys/<container>.
# Prima di avviare sshd, assicurati che le chiavi host siano presenti (necessarie per sshd) e avvialo:
if [ ! -f /etc/ssh/ssh_host_rsa_key ]; then
	ssh-keygen -A
fi
/usr/sbin/sshd -D &


# Per ogni container, genera la chiave nella directory dedicata:
## Per ambari-agent1:
# Entra nel container ambari-agent1
docker exec -it ambari-agent1 bash

# Installa openssh-server se non è già presente
# CentOS base nelle immagini potrebbe già includere SSH.
# Se mancante:
yum install -y openssh-clients openssh-server

# Genera la chiave SSH in modo persistente (nella cartella montata)
ssh-keygen -t rsa -N "" -f /root/.ssh/id_rsa   # (dentro il container, con volume ./ssh_keys/agent1)

# Avvia il demone SSH per abilitare l'accesso:
# Prima di avviare sshd, assicurati che le chiavi host siano presenti (necessarie per sshd) e avvialo:
if [ ! -f /etc/ssh/ssh_host_rsa_key ]; then
	ssh-keygen -A
fi
/usr/sbin/sshd -D &

## Per ambari-agent2:
# Entra nel container ambari-agent2
docker exec -it ambari-agent2 bash


# Installa openssh-clients se non è già presente
yum install -y openssh-clients openssh-server
# Genera la chiave SSH in modo persistente (nella cartella montata)
ssh-keygen -t rsa -N "" -f /root/.ssh/id_rsa   # (dentro il container, con volume ./ssh_keys/agent2)

# Avvia il demone SSH per abilitare l'accesso:
if [ ! -f /etc/ssh/ssh_host_rsa_key ]; then
	ssh-keygen -A
fi
/usr/sbin/sshd -D &

## Per ambari-agent3:
# Entra nel container ambari-agent3
docker exec -it ambari-agent3 bash

# Installa openssh-clients se non è già presente
yum install -y openssh-clients openssh-server
# genera chiave SSH in modo persistente (nella cartella montata)
ssh-keygen -t rsa -N "" -f /root/.ssh/id_rsa   # (dentro il container, con volume ./ssh_keys/agent3)
# Avvia il demone SSH per abilitare l'accesso e le chiavi host sono persistenti nella directory montata ./ssh_host_keys/<container>):
if [ ! -f /etc/ssh/ssh_host_rsa_key ]; then
	ssh-keygen -A
fi
/usr/sbin/sshd -D &

# Ora ogni chiave sarà visibile nella rispettiva cartella ./ssh_keys/<nome> sul tuo host



# Exit the container
exit

# Configure SSH on the other containers (bigtop_hostname1, bigtop_hostname2, bigtop_hostname3)
# Repeat SSH configuration on all other containers (hostname1, 2, 3)

# Genera la chiave SSH in modo persistente (nella cartella montata)
ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa
# Avvia il servizio SSH (le chiavi host sono persistenti nella directory montata ./ssh_host_keys/<container>):
if [ ! -f /etc/ssh/ssh_host_rsa_key ]; then
	ssh-keygen -A
fi
/usr/sbin/sshd -D &
exit


# Genera la chiave SSH in modo persistente (nella cartella montata)
ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa
# Avvia il servizio SSH (usa sempre il path assoluto per evitare errori):
/usr/sbin/sshd -D &
exit


# Genera la chiave SSH in modo persistente (nella cartella montata)
ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa
# Avvia il servizio SSH (usa sempre il path assoluto per evitare errori):
/usr/sbin/sshd -D &
exit


## Copy SSH key from server to agents
# Assicurati che la chiave pubblica esista prima di copiarla:
if docker exec ambari-server test -f /root/.ssh/id_rsa.pub; then
	docker cp ambari-server:/root/.ssh/id_rsa.pub /tmp/id_rsa.pub
	cat /tmp/id_rsa.pub | docker exec -i ambari-agent1 bash -c 'cat >> ~/.ssh/authorized_keys'
	cat /tmp/id_rsa.pub | docker exec -i ambari-agent2 bash -c 'cat >> ~/.ssh/authorized_keys'
	cat /tmp/id_rsa.pub | docker exec -i ambari-agent3 bash -c 'cat >> ~/.ssh/authorized_keys'
	rm /tmp/id_rsa.pub
else
	echo "La chiave pubblica /root/.ssh/id_rsa.pub non esiste su ambari-server. Generala prima con ssh-keygen."
fi


# Entra nel container primario per testare le connessioni SSH
docker exec -it ambari-server bash

# Test SSH connections (da dentro ambari-server)
ssh -o StrictHostKeyChecking=no ambari-agent1 echo "Connection successful"
ssh -o StrictHostKeyChecking=no ambari-agent2 echo "Connection successful"
ssh -o StrictHostKeyChecking=no ambari-agent3 echo "Connection successful"
exit

# Disable SELinux on all containers
docker exec -it ambari-server bash -c "setenforce 0 && sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config"
docker exec -it ambari-agent1 bash -c "setenforce 0 && sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config"
docker exec -it ambari-agent2 bash -c "setenforce 0 && sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config"
docker exec -it ambari-agent3 bash -c "setenforce 0 && sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config"


## Install necessary packages on all containers (opzionale)
# Le immagini Hortonworks includono già i componenti Ambari.
# Usa yum anziché dnf se devi installare utilities aggiuntive.


# =============================
# Install Ambari Server and Agents
# =============================

## Install Ambari Server on bigtop_hostname0
docker exec -it ambari-repo-bigtop_hostname0-1 bash

# Add Ambari repository

# Scarica e installa manualmente Ambari Server (repository non più disponibile)
cd /tmp
curl -O https://archive.apache.org/dist/ambari/ambari-2.7.7.0/redhat8/2.7.7.0-118/ambari-server-2.7.7.0-118.noarch.rpm
curl -O https://archive.apache.org/dist/ambari/ambari-2.7.7.0/redhat8/2.7.7.0-118/ambari-log4j-2.7.7.0-118.noarch.rpm
yum localinstall -y ambari-server-2.7.7.0-118.noarch.rpm ambari-log4j-2.7.7.0-118.noarch.rpm
cd -

# Install Ambari Server
yum install -y ambari-server

# Setup Ambari Server (uses default settings: JDK 8, Postgres embedded, default user)
ambari-server setup -s

# Start Ambari Server
ambari-server start

# Verify Ambari Server is running on port 8080
netstat -tlnp | grep 8080

exit

# Ristart yum repository configuration to use vault.centos.org for CentOS 7

cd /etc/yum.repos.d

# Togli vecchi file/conflicti
rm -f CentOS-Base.repo epel.repo epel-testing.repo epel*.rpmsave epel*.rpmnew

# Scrivi i repo solo su HTTP (vault) e un singolo EPEL
cd /etc/yum.repos.d

# elimina vecchi repo (anche epel duplicati)
rm -f CentOS-*.repo epel*.repo

# scrivi repo espliciti su vault (niente https, niente mirrorlist)
cd /etc/yum.repos.d
rm -f CentOS-*.repo epel*.repo

cat > CentOS-Vault.repo <<'EOF'
[base]
name=CentOS-7 - Base
baseurl=http://archive.kernel.org/centos-vault/7.9.2009/os/$basearch/
gpgcheck=0
enabled=1

[updates]
name=CentOS-7 - Updates
baseurl=http://archive.kernel.org/centos-vault/7.9.2009/updates/$basearch/
gpgcheck=0
enabled=1

[extras]
name=CentOS-7 - Extras
baseurl=http://archive.kernel.org/centos-vault/7.9.2009/extras/$basearch/
gpgcheck=0
enabled=1
EOF

cat > epel.repo <<'EOF'
[epel]
name=EPEL 7
baseurl=https://dl.fedoraproject.org/pub/epel/7/$basearch/
enabled=1
gpgcheck=0
EOF

sed -i 's/^enabled=1/enabled=0/' /etc/yum/pluginconf.d/fastestmirror.conf

yum clean all
yum makecache


# opzionale - Rigenerazione cache yum

cd /etc/yum.repos.d
sed -i 's/^enabled=1/enabled=0/' epel.repo
yum clean all
yum makecache

# Install NTP packages on all containers (opzionale, ma consigliato)
yum install -y ntp ntpdate

# Controllo che non restino URL https di vault
grep -R "vault.centos.org" /etc/yum.repos.d
curl -I http://vault.centos.org/centos/7.9.2009/os/x86_64/repodata/repomd.xml

yum clean all
yum makecache


# Install NTP packages on all containers (opzionale, ma consigliato)
yum install -y ntp ntpdate
ntpdate pool.ntp.org

# sincronizza una volta
ntpdate pool.ntp.org

# avvia ntpd in foreground come demone semplice (non esistendo su docker systemd )
ntpd -g -c /etc/ntp.conf -p /var/run/ntpd.pid -u ntp:ntp

# Install JDK 8 on all containers (necessario per Ambari 2.7.x)
curl -fsSL -o /tmp/jdk8.tar.gz https://cdn.azul.com/zulu/bin/zulu8.74.0.17-ca-jdk8.0.392-linux_x64.tar.gz
docker cp /tmp/jdk8.tar.gz docker-ambari:/opt/jdk8/jdk8.tar.gz
docker exec -it docker-ambari bash -lc '
set -e
mkdir -p /opt/jdk8
cd /opt/jdk8
tar -xzf jdk8.tar.gz && rm -f jdk8.tar.gz
JDK_HOME=$(echo /opt/jdk8/* | awk "{print \$1}")
[ -x "$JDK_HOME/bin/java" ] || { echo "java binary not found in $JDK_HOME"; exit 1; }
ln -sfn "$JDK_HOME" /opt/jdk8/current
/opt/jdk8/current/bin/java -version
'


# Vedi i nomi attivi
docker ps --format '{{.Names}}'

# se lo stack non è su, avvia:
# docker-compose -f docker-compose.ambari.yml up -d   (oppure: docker compose ...)

# Copia il JDK dentro ambari-server
docker cp /tmp/jdk8.tar.gz ambari-server:/opt/jdk8/jdk8.tar.gz

# Scompatta e verifica
docker exec -it ambari-server bash -lc '
set -e
mkdir -p /opt/jdk8
cd /opt/jdk8
tar -xzf jdk8.tar.gz && rm -f jdk8.tar.gz
JDK_HOME=$(echo /opt/jdk8/* | awk "{print \$1}")
[ -x "$JDK_HOME/bin/java" ] || { echo "java binary not found in $JDK_HOME"; exit 1; }
ln -sfn "$JDK_HOME" /opt/jdk8/current
/opt/jdk8/current/bin/java -version
'

# torno dentro ambari server
docker exec -it ambari-server bash	

# Se hai già estratto il JDK 8 in /opt/jdk8/current, usa quello.
# Altrimenti installa un JDK 8 rapido:
yum install -y java-1.8.0-openjdk-devel

# Install Maven 3.6.3 on ambari-server (necessario per build progetti)
cd /opt
curl -fL http://archive.apache.org/dist/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz -o maven.tgz
tar -xzf maven.tgz
ln -sfn /opt/apache-maven-3.6.3 /opt/maven

cat > /etc/profile.d/maven.sh <<'EOF'
export M2_HOME=/opt/maven
export PATH=$M2_HOME/bin:$PATH
export JAVA_HOME=/opt/jdk8/current   # se esiste; altrimenti usa /usr/lib/jvm/java-1.8.0-openjdk
export PATH=$JAVA_HOME/bin:$PATH
EOF
source /etc/profile.d/maven.sh

mvn -version
java -version


# Verifica Maven e Java
source /etc/profile.d/maven.sh
export JAVA_HOME=/opt/jdk8/current   # se esiste; altrimenti /usr/lib/jvm/java-1.8.0-openjdk
export PATH=$JAVA_HOME/bin:$PATH
mvn -version
java -version

# Entra in ambari-server per clonare il sorgente Ambari
docker exec -it ambari-server bash

# Install Git to clone Ambari source code
yum install -y git
cd /
git clone https://github.com/apache/ambari.git ambari
cd /ambari
git checkout release-2.7.5

# Build Ambari server from source
source /etc/profile.d/maven.sh
export JAVA_HOME=/opt/jdk8/current    # oppure /usr/lib/jvm/java-1.8.0-openjdk
export PATH=$JAVA_HOME/bin:$PATH
mvn -version
java -version

# Build Ambari server (skip Ambari Web and Admin for faster build)
cd /ambari
mvn -B -fae clean install -DskipTests -DskipITs -Drat.skip=true -Dfindbugs.skip=true -Dpython.ver=python2.7 \
  -DskipAmbariWeb -DskipAmbariAdmin -pl '!ambari-web,!ambari-logsearch/ambari-logsearch-web,!ambari-admin' -am














# Verifica che non restino URL https di CentOS
grep -R "https://vault.centos.org" /etc/yum.repos.d || true
grep -R "http://vault.centos.org" /etc/yum.repos.d

yum clean all
yum makecache



## Access Ambari Web UI
# Open browser and navigate to:
# http://localhost:8080  (or http://192.168.1.230:8080 from remote)
#
# Default credentials:
# Username: admin
# Password: admin
#
# From Ambari Web UI, you can now:
# 1. Create a cluster
# 2. Install Hadoop services (HDFS, YARN, etc.)
# 3. Manage and monitor your cluster